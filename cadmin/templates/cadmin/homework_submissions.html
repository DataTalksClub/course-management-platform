{% extends 'cadmin/base.html' %}

{% load custom_filters %}

{% block breadcrumbs %}
  <li><a href="{% url 'cadmin_course_list' %}">Course Admin</a></li>
  <li><a href="{% url 'cadmin_course' course.slug %}">{{ course.title }}</a></li>
  <li><a href="{% url 'cadmin_homework_submissions' course.slug homework.slug %}">{{ homework.title }} Submissions</a></li>
{% endblock %}

{% block cadmin_content %}
<h2>{{ homework.title }} - Submissions</h2>

<div class="mb-3">
  <a href="{% url 'cadmin_course' course.slug %}" class="btn btn-secondary">Back to Course Admin</a>
  <a href="{% url 'homework' course.slug homework.slug %}" class="btn btn-info">View Homework</a>
</div>

<div class="alert alert-info" role="alert">
  <strong>Total Submissions:</strong> {{ submissions_data|length }}
</div>

{% if submissions_data %}
<div class="mb-3">
  <label for="sortBy">Sort by:</label>
  <select id="sortBy" class="form-control form-control-sm d-inline-block" style="width: auto;">
    <option value="email">Email</option>
    <option value="submitted" selected>Submitted At</option>
    <option value="score">Score</option>
  </select>
  <button onclick="sortTable()" class="btn btn-sm btn-primary">Sort</button>
  
  <input type="text" id="searchBox" class="form-control form-control-sm d-inline-block ml-3" placeholder="Search by email..." style="width: 250px;" onkeyup="filterTable()">
</div>

<div class="table-responsive">
  <table class="table table-striped table-sm" id="submissionsTable">
    <thead>
      <tr>
        <th>Email</th>
        <th>Submitted At</th>
        <th>Score</th>
        {% for question in questions %}
        <th>Q{{ forloop.counter }}</th>
        {% endfor %}
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for data in submissions_data %}
      <tr>
        <td>{{ data.submission.student.email }}</td>
        <td>{{ data.submission.submitted_at|date:"Y-m-d H:i" }}</td>
        <td>
          {% if data.submission.total_score is not None %}
            {{ data.submission.total_score }}
          {% else %}
            -
          {% endif %}
        </td>
        {% for answer in data.answers %}
        <td>
          <span title="{{ answer }}">
            {% if answer|length > 20 %}
              {{ answer|slice:":20" }}...
            {% else %}
              {{ answer }}
            {% endif %}
          </span>
        </td>
        {% endfor %}
        <td>
          <a href="{% url 'cadmin_homework_submission_edit' course.slug homework.slug data.submission.id %}" 
             class="btn btn-sm btn-primary" 
             title="Edit submission">
            <i class="fas fa-edit"></i> Edit
          </a>
          <form method="post" action="{% url 'loginas-user-login' data.submission.student.id %}" style="display: inline;">
            {% csrf_token %}
            <input type="hidden" name="next" value="{% url 'cadmin_homework_submissions' course.slug homework.slug %}">
            <button type="submit" class="btn btn-sm btn-info" title="Log in as {{ data.submission.student.email }}">
              <i class="fas fa-user-circle"></i> Log in as
            </button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
const MISSING_SCORE_VALUE = -999; // Used for sorting when score is missing

function sortTable() {
  const table = document.getElementById('submissionsTable');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const sortBy = document.getElementById('sortBy').value;
  
  rows.sort((a, b) => {
    let aVal, bVal;
    if (sortBy === 'email') {
      aVal = a.cells[0].textContent.trim();
      bVal = b.cells[0].textContent.trim();
      return aVal.localeCompare(bVal);
    } else if (sortBy === 'submitted') {
      aVal = a.cells[1].textContent.trim();
      bVal = b.cells[1].textContent.trim();
      return bVal.localeCompare(aVal); // Descending
    } else if (sortBy === 'score') {
      aVal = a.cells[2].textContent.trim();
      bVal = b.cells[2].textContent.trim();
      aVal = aVal === '-' ? MISSING_SCORE_VALUE : parseFloat(aVal);
      bVal = bVal === '-' ? MISSING_SCORE_VALUE : parseFloat(bVal);
      return bVal - aVal; // Descending
    }
    return 0;
  });
  
  rows.forEach(row => tbody.appendChild(row));
}

function filterTable() {
  const searchBox = document.getElementById('searchBox');
  const filter = searchBox.value.toLowerCase();
  const table = document.getElementById('submissionsTable');
  const rows = table.querySelectorAll('tbody tr');
  
  rows.forEach(row => {
    const email = row.cells[0].textContent.toLowerCase();
    if (email.includes(filter)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}
</script>
{% else %}
<p>No submissions yet.</p>
{% endif %}
{% endblock %}
