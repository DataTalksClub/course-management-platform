{% extends 'cadmin/base.html' %}

{% load custom_filters %}

{% block breadcrumbs %}
  <li><a href="{% url 'cadmin_course_list' %}">Course Admin</a></li>
  <li><a href="{% url 'cadmin_course' course.slug %}">{{ course.title }}</a></li>
{% endblock %}

{% block cadmin_content %}
<h2>{{ course.title }} - Admin Panel</h2>

<div class="mb-3">
  <a href="{% url 'course' course.slug %}" class="btn btn-secondary">View Course Page</a>
  <a href="{% url 'dashboard' course.slug %}" class="btn btn-info">Course Dashboard</a>
  <a href="{% url 'leaderboard' course.slug %}" class="btn btn-primary">Leaderboard</a>
</div>

<div class="mb-3">
  <strong>Django Admin:</strong>
  <a href="/admin/courses/course/{{ course.id }}/change/">
    <i class="fas fa-edit"></i> Edit Course
  </a>
</div>

<div class="alert alert-info" role="alert">
  <strong>Total Enrollments:</strong> {{ total_enrollments }}
</div>

<!-- Homework Section -->
<div class="card mb-4">
  <div class="card-header">
    <h3>Homework</h3>
  </div>
  <div class="card-body">
    {% if homeworks %}
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Title</th>
            <th>Due Date</th>
            <th>State</th>
            <th>Submissions</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for hw in homeworks %}
          <tr>
            <td>
              <a href="{% url 'cadmin_homework_submissions' course.slug hw.slug %}">{{ hw.title }}</a>
              <a href="{% url 'homework' course.slug hw.slug %}" title="View Public Homework Page" class="ml-2">
                <i class="fas fa-external-link-alt"></i>
              </a>
            </td>
            <td>{{ hw.due_date|date:"Y-m-d" }}</td>
            <td>
              {% if hw.state == 'OP' %}
                <span class="badge badge-success">Open</span>
              {% elif hw.state == 'CL' %}
                <span class="badge badge-secondary">Closed</span>
              {% elif hw.state == 'SC' %}
                <span class="badge badge-primary">Scored</span>
              {% else %}
                <span class="badge badge-warning">{{ hw.get_state_display }}</span>
              {% endif %}
            </td>
            <td>{{ hw.submissions_count }}</td>
            <td>
              <form method="post" style="display: inline;">
                {% csrf_token %}
                <select class="form-control form-control-sm d-inline-block" style="width: auto;" name="action" id="hw-action-{{ hw.id }}">
                  <option value="">Select action...</option>
                  {% if hw.state == 'CL' %}
                    <option value="{% url 'cadmin_homework_set_correct_answers' course.slug hw.slug %}">Set Correct Answers</option>
                    <option value="{% url 'cadmin_homework_score' course.slug hw.slug %}">Score</option>
                  {% endif %}
                  <option value="{% url 'homework_statistics' course.slug hw.slug %}">View Statistics</option>
                </select>
                <button type="button" class="btn btn-sm btn-primary" onclick="applyAction('hw-action-{{ hw.id }}')">Apply</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p>No homework found for this course.</p>
    {% endif %}
  </div>
</div>

<!-- Project Section -->
<div class="card mb-4">
  <div class="card-header">
    <h3>Projects</h3>
  </div>
  <div class="card-body">
    {% if projects %}
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Title</th>
            <th>Due Dates</th>
            <th>State</th>
            <th>Submissions</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for proj in projects %}
          <tr>
            <td>
              <a href="{% url 'cadmin_project_submissions' course.slug proj.slug %}">{{ proj.title }}</a>
              <a href="{% url 'project' course.slug proj.slug %}" title="View Public Project Page" class="ml-2">
                <i class="fas fa-external-link-alt"></i>
              </a>
            </td>
            <td>
              Sub: {{ proj.submission_due_date|date:"Y-m-d" }}<br>
              Rev: {{ proj.peer_review_due_date|date:"Y-m-d" }}
            </td>
            <td>
              {% if proj.state == 'CL' %}
                <span class="badge badge-secondary">Closed</span>
              {% elif proj.state == 'CS' %}
                <span class="badge badge-success">Collecting</span>
              {% elif proj.state == 'PR' %}
                <span class="badge badge-warning">Peer Review</span>
              {% elif proj.state == 'CO' %}
                <span class="badge badge-primary">Completed</span>
              {% else %}
                <span class="badge badge-info">{{ proj.get_state_display }}</span>
              {% endif %}
            </td>
            <td>{{ proj.submissions_count }}</td>
            <td>
              <form method="post" style="display: inline;">
                {% csrf_token %}
                <select class="form-control form-control-sm d-inline-block" style="width: auto;" name="action" id="proj-action-{{ proj.id }}">
                  <option value="">Select action...</option>
                  {% if proj.state == 'CS' %}
                    <option value="{% url 'cadmin_project_assign_reviews' course.slug proj.slug %}">Assign Reviews</option>
                  {% endif %}
                  {% if proj.state == 'PR' %}
                    <option value="{% url 'cadmin_project_score' course.slug proj.slug %}">Score</option>
                  {% endif %}
                  <option value="{% url 'project_statistics' course.slug proj.slug %}">View Statistics</option>
                </select>
                <button type="button" class="btn btn-sm btn-primary" onclick="applyAction('proj-action-{{ proj.id }}')">Apply</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p>No projects found for this course.</p>
    {% endif %}
  </div>
</div>

<script>
function applyAction(selectId) {
  const select = document.getElementById(selectId);
  const url = select.value;
  
  if (!url) {
    alert('Please select an action');
    return;
  }
  
  // For statistics, open in same tab
  if (url.includes('statistics')) {
    window.location.href = url;
    return;
  }
  
  // For other actions, confirm first
  if (confirm('Are you sure you want to perform this action?')) {
    window.location.href = url;
  }
}
</script>
{% endblock %}
