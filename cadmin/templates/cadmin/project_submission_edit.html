{% extends 'base.html' %}

{% load custom_filters %}

{% block breadcrumbs %}
  <li><a href="{% url 'cadmin_course_list' %}">Course Admin</a></li>
  <li><a href="{% url 'cadmin_course' course.slug %}">{{ course.title }}</a></li>
  <li><a href="{% url 'cadmin_project_submissions' course.slug project.slug %}">{{ project.title }} Submissions</a></li>
  <li><a href="{% url 'cadmin_project_submission_edit' course.slug project.slug submission.id %}">Edit Submission</a></li>
{% endblock %}

{% block content %}
<h2>Edit Project Submission</h2>

{% if messages %}
<div class="messages">
  {% for message in messages %}
  <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="mb-3">
  <a href="{% url 'cadmin_project_submissions' course.slug project.slug %}" class="btn btn-secondary">Back to Submissions</a>
</div>

<div class="alert alert-info" role="alert">
  <strong>Student:</strong> {{ submission.student.username }} ({{ submission.student.email }})<br>
  <strong>Project:</strong> {{ project.title }}<br>
  <strong>Submitted:</strong> {{ submission.submitted_at|date:"Y-m-d H:i" }}<br>
  <strong>Repository:</strong> <a href="{{ submission.github_link }}" target="_blank">{{ submission.github_link }}</a>
</div>

<form method="post">
  {% csrf_token %}
  
  <div class="card mb-3">
    <div class="card-header">
      <h4>Review Criteria Scores</h4>
    </div>
    <div class="card-body">
      {% if criteria_with_scores %}
        {% for item in criteria_with_scores %}
        <div class="card mb-3 border-secondary">
          <div class="card-header bg-light">
            <strong>{{ item.criteria.description }}</strong>
          </div>
          <div class="card-body">
            <div class="mb-2">
              <strong>Score Options:</strong>
              <ul class="mb-2">
                {% for option in item.criteria.options %}
                <li>{{ option.criteria }}: {{ option.score }} points</li>
                {% endfor %}
              </ul>
            </div>
            <div class="form-group">
              <label for="criteria_score_{{ item.criteria.id }}">Score for this criterion:</label>
              <input type="number" 
                     class="form-control criteria-score" 
                     id="criteria_score_{{ item.criteria.id }}" 
                     name="criteria_score_{{ item.criteria.id }}" 
                     value="{{ item.score }}" 
                     min="0"
                     required>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No review criteria defined for this course.</p>
      {% endif %}
      
      <div class="form-group mb-3">
        <label for="project_score">Total Project Score (from criteria above)</label>
        <input type="number" class="form-control" id="project_score" name="project_score" value="{{ submission.project_score }}" readonly>
        <small class="form-text text-muted">This is automatically calculated from the criteria scores above.</small>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">
      <h4>Additional Project Scores</h4>
    </div>
    <div class="card-body">
      <div class="form-group mb-3">
        <label for="project_faq_score">Project FAQ Score</label>
        <input type="number" class="form-control additional-score" id="project_faq_score" name="project_faq_score" value="{{ submission.project_faq_score }}" required>
      </div>
      
      <div class="form-group mb-3">
        <label for="project_learning_in_public_score">Project Learning in Public Score</label>
        <input type="number" class="form-control additional-score" id="project_learning_in_public_score" name="project_learning_in_public_score" value="{{ submission.project_learning_in_public_score }}" required>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">
      <h4>Peer Review Scores</h4>
    </div>
    <div class="card-body">
      <div class="form-group mb-3">
        <label for="peer_review_score">Peer Review Score</label>
        <input type="number" class="form-control peer-review-score" id="peer_review_score" name="peer_review_score" value="{{ submission.peer_review_score }}" required>
      </div>
      
      <div class="form-group mb-3">
        <label for="peer_review_learning_in_public_score">Peer Review Learning in Public Score</label>
        <input type="number" class="form-control peer-review-score" id="peer_review_learning_in_public_score" name="peer_review_learning_in_public_score" value="{{ submission.peer_review_learning_in_public_score }}" required>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">
      <h4>Overall Results</h4>
    </div>
    <div class="card-body">
      <div class="form-group mb-3">
        <label for="total_score">Total Score (automatically calculated)</label>
        <input type="number" class="form-control" id="total_score" name="total_score" value="{{ submission.total_score }}" readonly>
        <small class="form-text text-muted">This field is automatically calculated from the individual scores above.</small>
      </div>
      
      <div class="form-check mb-3">
        <input type="checkbox" class="form-check-input" id="reviewed_enough_peers" name="reviewed_enough_peers" {% if submission.reviewed_enough_peers %}checked{% endif %}>
        <label class="form-check-label" for="reviewed_enough_peers">
          Reviewed Enough Peers
        </label>
      </div>
      
      <div class="form-check mb-3">
        <input type="checkbox" class="form-check-input" id="passed" name="passed" {% if submission.passed %}checked{% endif %}>
        <label class="form-check-label" for="passed">
          Passed
        </label>
      </div>
    </div>
  </div>

  <div class="text-center">
    <button type="submit" class="btn btn-primary">Save Changes</button>
    <a href="{% url 'cadmin_project_submissions' course.slug project.slug %}" class="btn btn-secondary">Cancel</a>
  </div>
</form>

<script>
// Auto-calculate scores when individual scores change
document.addEventListener('DOMContentLoaded', function() {
  const criteriaScoreFields = document.querySelectorAll('.criteria-score');
  const additionalScoreFields = document.querySelectorAll('.additional-score');
  const peerReviewScoreFields = document.querySelectorAll('.peer-review-score');
  
  function calculateProjectScore() {
    // Calculate project score from criteria scores
    let projectScore = 0;
    criteriaScoreFields.forEach(function(field) {
      const value = parseInt(field.value, 10) || 0;
      projectScore += value;
    });
    const projectScoreField = document.getElementById('project_score');
    if (projectScoreField) {
      projectScoreField.value = projectScore;
    }
    return projectScore;
  }
  
  function calculateTotal() {
    // Calculate project score first
    const projectScore = calculateProjectScore();
    
    // Calculate total from all components
    let total = projectScore;
    
    // Add additional project scores
    additionalScoreFields.forEach(function(field) {
      const value = parseInt(field.value, 10) || 0;
      total += value;
    });
    
    // Add peer review scores
    peerReviewScoreFields.forEach(function(field) {
      const value = parseInt(field.value, 10) || 0;
      total += value;
    });
    
    const totalField = document.getElementById('total_score');
    if (totalField) {
      totalField.value = total;
    }
  }
  
  // Add event listeners to criteria score fields
  criteriaScoreFields.forEach(function(field) {
    field.addEventListener('input', calculateTotal);
    field.addEventListener('change', calculateTotal);
  });
  
  // Add event listeners to additional score fields
  additionalScoreFields.forEach(function(field) {
    field.addEventListener('input', calculateTotal);
    field.addEventListener('change', calculateTotal);
  });
  
  // Add event listeners to peer review score fields
  peerReviewScoreFields.forEach(function(field) {
    field.addEventListener('input', calculateTotal);
    field.addEventListener('change', calculateTotal);
  });
  
  // Calculate initial values
  calculateTotal();
});
</script>

{% endblock %}
