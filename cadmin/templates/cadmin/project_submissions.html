{% extends 'cadmin/base.html' %}

{% load custom_filters %}

{% block breadcrumbs %}
  <li><a href="{% url 'cadmin_course_list' %}">Course Admin</a></li>
  <li><a href="{% url 'cadmin_course' course.slug %}">{{ course.title }}</a></li>
  <li><a href="{% url 'cadmin_project_submissions' course.slug project.slug %}">{{ project.title }} Submissions</a></li>
{% endblock %}

{% block cadmin_content %}
<h2>{{ project.title }} - Submissions</h2>

<div class="mb-3">
  <a href="{% url 'cadmin_course' course.slug %}" class="btn btn-secondary">Back to Course Admin</a>
  <a href="{% url 'project' course.slug project.slug %}" class="btn btn-info">View Project</a>
</div>

<div class="alert alert-info" role="alert">
  <strong>Total Submissions:</strong> {{ submissions|length }}
</div>

{% if submissions %}
<div class="mb-3">
  <button id="copyEmailsBtn" class="btn btn-primary btn-sm" onclick="copyEmails()">
    <i class="fas fa-copy"></i> Copy All Emails
  </button>
  <span id="copyFeedback" class="ml-2 text-success" style="display: none;">
    <i class="fas fa-check"></i> Copied!
  </span>
  
  <label for="sortBy" class="ml-3">Sort by:</label>
  <select id="sortBy" class="form-control form-control-sm d-inline-block" style="width: auto;">
    <option value="email">Email</option>
    <option value="reviews">Reviews Completed</option>
    <option value="project_score">Project Score</option>
    <option value="total_score" selected>Total Score</option>
  </select>
  <button onclick="sortTable()" class="btn btn-sm btn-primary">Sort</button>
  
  <input type="text" id="searchBox" class="form-control form-control-sm d-inline-block ml-3" placeholder="Search by email..." style="width: 250px;" onkeyup="filterTable()">
</div>

<div class="table-responsive">
  <table class="table table-striped" id="submissionsTable">
    <thead>
      <tr>
        <th>Email</th>
        <th>Reviews Completed</th>
        <th>Project Score</th>
        <th>Total Score</th>
        <th>Passed</th>
        <th>Repository URL</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for submission in submissions %}
      <tr>
        <td>{{ submission.student.email }}</td>
        <td>
          {{ submission.peer_reviews_completed }} / {{ submission.peer_reviews_total }}
        </td>
        <td>
          {% if submission.project_score is not None %}
            {{ submission.project_score }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if submission.total_score is not None %}
            {{ submission.total_score }}
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if submission.passed %}
            <span class="badge badge-success">Yes</span>
          {% elif submission.passed is not None %}
            <span class="badge badge-danger">No</span>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          {% if submission.github_link %}
            <a href="{{ submission.github_link }}" target="_blank">View</a>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          <a href="{% url 'cadmin_project_submission_edit' course.slug project.slug submission.id %}" class="btn btn-sm btn-primary">
            <i class="fas fa-edit"></i> Edit
          </a>
          <a href="/admin/login/user/{{ submission.student.id }}/?next={% url 'cadmin_project_submissions' course.slug project.slug %}" 
             class="btn btn-sm btn-info" 
             title="Log in as {{ submission.student.email }}">
            <i class="fas fa-user-circle"></i> Log in as
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<p>No submissions yet.</p>
{% endif %}

<script>
function copyEmails() {
  const emails = [
    {% for submission in submissions %}
    "{{ submission.student.email }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  
  const emailText = emails.join(', ');
  
  // Create a temporary textarea to copy the emails
  const textarea = document.createElement('textarea');
  textarea.value = emailText;
  document.body.appendChild(textarea);
  textarea.select();
  document.execCommand('copy');
  document.body.removeChild(textarea);
  
  // Show feedback
  const feedback = document.getElementById('copyFeedback');
  feedback.style.display = 'inline';
  setTimeout(() => {
    feedback.style.display = 'none';
  }, 2000);
}

function sortTable() {
  const table = document.getElementById('submissionsTable');
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const sortBy = document.getElementById('sortBy').value;
  
  rows.sort((a, b) => {
    let aVal, bVal;
    if (sortBy === 'email') {
      aVal = a.cells[0].textContent.trim();
      bVal = b.cells[0].textContent.trim();
      return aVal.localeCompare(bVal);
    } else if (sortBy === 'reviews') {
      aVal = a.cells[1].textContent.trim().split('/')[0];
      bVal = b.cells[1].textContent.trim().split('/')[0];
      return parseInt(bVal) - parseInt(aVal); // Descending
    } else if (sortBy === 'project_score') {
      aVal = a.cells[2].textContent.trim();
      bVal = b.cells[2].textContent.trim();
      aVal = aVal === '-' ? -999 : parseFloat(aVal);
      bVal = bVal === '-' ? -999 : parseFloat(bVal);
      return bVal - aVal; // Descending
    } else if (sortBy === 'total_score') {
      aVal = a.cells[3].textContent.trim();
      bVal = b.cells[3].textContent.trim();
      aVal = aVal === '-' ? -999 : parseFloat(aVal);
      bVal = bVal === '-' ? -999 : parseFloat(bVal);
      return bVal - aVal; // Descending
    }
    return 0;
  });
  
  rows.forEach(row => tbody.appendChild(row));
}

function filterTable() {
  const searchBox = document.getElementById('searchBox');
  const filter = searchBox.value.toLowerCase();
  const table = document.getElementById('submissionsTable');
  const rows = table.querySelectorAll('tbody tr');
  
  rows.forEach(row => {
    const email = row.cells[0].textContent.toLowerCase();
    if (email.includes(filter)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}
</script>
{% endblock %}
