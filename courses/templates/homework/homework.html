{% extends 'base.html' %}

{% load static %}

{% block styles %}
<style>
  .homework-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .homework-title {
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
    margin-bottom: 20px;
  }

  .homework-meta {
    background-color: #e9ecef;
    border-radius: 4px;
    padding: 10px;
    margin-bottom: 20px;
  }

  .question {
    background-color: #fff;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 20px;
  }

  .question-text {
    font-weight: bold;
    color: #495057;
  }

  .form-check {
    margin-bottom: 10px;
  }

  .form-control:focus {
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
  }

  .btn-primary {
    background-color: #007bff;
    border-color: #007bff;
  }

  .btn-primary:hover {
    background-color: #0056b3;
    border-color: #0056b3;
  }

  .alert {
    border-radius: 4px;
  }

  .text-muted {
    font-size: 0.9em;
  }
</style>
{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item active" aria-current="page"><a href="{% url 'course' course.slug %}">{{ course.title }}</a></li>
{% endblock breadcrumbs %}
{% block content %}
<div class="homework-container">
  <h2 class="homework-title text-center">
    {{ homework.title }} for
    <a href="{% url 'course' course.slug %}">{{ course.title }}</a>
  </h2>

  {% if messages %}
    {% for message in messages %}
    {% if 'homework' in message.tags %}
      <div class="alert {{ message.tags }}">
        <p>{{ message }}</p>
      </div>
    {% endif %}
    {% endfor %}
  {% endif %}

  {% if errors %}
    {% for error in errors %}
      <div class="alert alert-danger">
        <p>{{ error }}</p>
      </div>
    {% endfor %}
  {% endif %}

  {% if homework.is_scored %}
    {% if submission %}
      <div class="alert alert-success">
        <p>This homework is already scored. Your score is {{ submission.total_score }}.</p>
      </div>
    {% else %}
      <div class="alert alert-warning">
        <p>This homework is already scored. You didn't submit your answers.</p>
      </div>
    {% endif %}
  {% endif %}

  <div class="homework-meta">
    <p class="text-muted mb-2">{{ homework.description }}</p>
    <p class="mb-0">Due date: <span class="local-date font-weight-bold">{{ homework.due_date |date:"c" }}</span> (local time)</p>
  </div>

  {% if not is_authenticated %}
    <div class="mt-4 text-center">
      <p>Please <a href="{% url 'login' %}">log in</a> to submit your answers.</p>
    </div>
  {% endif %}

  <h3 class="mb-3">Questions</h3>

  <form method="post" class="needs-validation" novalidate>
    {% if is_authenticated %}
      {% csrf_token %}
    {% endif %}

    {% for question, answer in question_answers %}
      <div class="question">
        <p class="question-text">
          Question {{ forloop.counter }}. {{ question.text }}
          {% if question.scores_for_correct_answer != 0 %}
            <span class="text-muted">
              ({{ question.scores_for_correct_answer }}
              {{ question.scores_for_correct_answer|pluralize:"point,points" }})
            </span>
          {% else %}
            <span class="text-muted">(not graded)</span>
          {% endif %}
        </p>

        {% if question.question_type == 'MC' %}
          {% for option in answer.options %}
            <div class="form-check {{ option.correctly_selected_class }}">
              <input
                class="form-check-input"
                id="radio-{{ question.id }}-{{ forloop.counter }}"
                type="radio"
                name="answer_{{ question.id }}"
                value="{{ option.index }}"
                {% if option.is_selected %} checked {% endif %}
                {% if disabled %} disabled {% endif %}
              />
              <label class="form-check-label" for="radio-{{ question.id }}-{{ forloop.counter }}">{{ option.value }}</label>
            </div>
          {% endfor %}

        {% elif question.question_type == 'CB' %}
          {% for option in answer.options %}
            <div class="form-check">
              <input
                class="form-check-input"
                id="checkbox-{{ question.id }}-{{ forloop.counter }}"
                type="checkbox"
                name="answer_{{ question.id }}"
                value="{{ option.index }}"
                {% if option.is_selected %} checked {% endif %}
                {% if disabled %} disabled {% endif %}
              />
              <label class="form-check-label" for="checkbox-{{ question.id }}-{{ forloop.counter }}">{{ option.value }}</label>
            </div>
          {% endfor %}

        {% elif question.question_type == 'FF' %}
          <input
            class="form-control"
            type="text"
            name="answer_{{ question.id }}"
            value="{{ answer.text|default:'' }}"
            {% if disabled %} disabled {% endif %}
          />
        {% endif %}
      </div>
    {% endfor %}

    {% if not homework.is_scored %}
      <div class="mt-4 text-center">
        {% if is_authenticated %}
          <button
              id="submit-button"
              type="submit"
              class="btn btn-primary btn-lg">
            {% if not submission %}
              Submit
            {% else %}
              Update
            {% endif %}
          </button>
        {% else %}
          <p>Please <a href="{% url 'login' %}">log in</a> to submit your answers.</p>
        {% endif %}
      </div>
    {% endif %}
  </form>

  {% if submission %}
    <p class="text-muted question-text m-0 mt-3">Last submission at: {{ submission.submitted_at|date:"F d, Y H:i" }}</p>
  {% endif %}

  <script>
    $(function () {
      $('[data-toggle="tooltip"]').tooltip()
    });
  </script>

  <script src="{% static 'homework.js' %}"></script>
</div>
{% endblock %}